# PHP-CS-FixerとGitを使って規約に則った快適なコーディングライフを
:hp-alt-title:　PHP-CSとGitを使って規約に則った快適なコーディングライフを
:hp-tags: Hasumin, php-cs, php-cs-fixer, git

こんにちは。はすみんです。 +

弊社の開発ではPHPを主に使っているのですが、 +
それなりに歴史が長いからこそ、遺産が溜まっていることがたまにあります。 +

例えばコーディング規約などです。 +

「PSR-2に準拠してコーディングしようよ」となったのも、プロダクトがそれなりに成熟し始めてからでして、 +
そのため、過去実装したプログラムには規約に沿っていないソースコードもたまにあり、 +
コードレビューのたびにスペースがないとか不毛な会話は繰り返ししたくないな〜と思っていました。 +

とはいえ大きなプロダクトなのでまるっと改修を加えるのは、工数的にもメンタル的にも大変です。 +
ならば自分が手を加えたソースコードだけは規約に沿ったものにしていき、 +
規約に沿ったソースコードを徐々に作っていけば全体の保守性はあがるはずです。 +

そこでPHP-CS-Fixerという規約に沿ったコードを自動補正するツールを使いました。 +
コミットするファイル単位で実行するようにしたのですが、ファイルを選択して逐一実行するのも大変なので、 +
コミット時に自動補正するか聞いて実行するようにしました。 +

## 作ったもの
こんな感じです。 +
image:/images/hasumi/php-cs/phpcs.gif[]

コミットしようとしているファイルをすべてチェックします。 +
規約に沿っていないとコミットされません。 +
また、インタラクティブに自動補正するかどうかユーザに聞いて実行します。 +

## 書いたコード
こんな感じです。 +

----
######################################
# commitごとに規約に沿っているかチェックする
######################################
# IS_ERRORでコミットするかどうか判定する関数
function execFix() {
    echo "対象のファイルに修正を実行しますか？ [Y/n]"
    exec < /dev/tty
    read input

    if [ -z $input ]; then
        echo "alert: y or nを入力してください"
        execFix
    elif [ $input = 'y' ] || [ $input = 'Y' ] || [ $input = 'yes' ]; then
        echo "php-cs-fixerを実行します"
        # 対象ファイル毎にphp-cs-fixerの実行
        for FILE in `git status -uno --short | cut -c3-`; do
            php-cs-fixer fix $FILE
        done
        echo "php-cs-fixerの実行が完了しました。対象ファイルを確認してください。"
        exit 1
    elif [ $input = 'n' ] || [ $input = 'N' ] || [ $input = 'no' ]; then
        echo "処理を終了します。規約に沿ってコーディングしてからコミットしてください。"
        exit 1
    fi
}

# 実行部
# コミットしようとしているファイルだけを規約に則っているかチェック
echo "Files check by php-cs"
echo "＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝"
IS_ERROR=0
# cutでファイル名を取得
for FILE in `git status -uno --short | cut -c3-`; do
    # 対象のファイルをphp-csでチェック
    array=(`phpcs $FILE --standard=./lf-phpcs.xml | grep FOUND`)
    # php-csが表示するエラー数を判定。[1]番目にエラー数が表示される。
    if test ${array[1]} != 0; then
        # エラーがあればcommitさせない
        echo "PHPCS Err In: ${FILE}"
        IS_ERROR=1
    else
        echo "No Err, be commited"
    fi
done
echo "＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝"

# php-cs-fixerを実行するか
if test $IS_ERROR = 1 ;then
    execFix
fi
######################################
----

流れとしてはこんな感じです。 +
```
コミットするファイルを規約に沿っているかチェック
|_ 沿っていればそのままコミット
|_ 沿っていなければ対象のファイル名を表示
  |_ PHP-CS-Fixerを使って自動補正
    |_ 自動補正して処理を修了（再度git add）
  |_ 何もしない
```

気をつけなければいけないのは +
----
exec < /dev/tty
----
部分で、gitのhookはインタラクティブなことが普通できなく、exec < /dev/ttyとすることでできるようになるようです。 +
参考：https://qiita.com/mkiken/items/af5c40ce0d0c6d3530c7 +
引用： +
----
gitのhookは普通にはインタラクティブなことができないらしく、readが使えなかった。
exec < /dev/tty
を追加することでreadができるようになる。
----

参考サイト： +
https://www.unitrust.co.jp/2426 +
https://blog.leko.jp/post/create-git-hook-to-develop-modern-php/ +

## おわりに
まだまだ便利にできそうなので、色々調べてみようと思いました。 +
シェルも勉強しよう。

done